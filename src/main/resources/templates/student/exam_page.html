<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${exam.title}">Exam Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #e9ecef; /* Light gray background */
        }

        /* --- Student Header --- */
        .student-header {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            padding: 1.5rem;
        }
        .student-pic {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #dee2e6;
        }
        .exam-details {
            font-size: 0.9rem;
            color: #495057;
        }
        .exam-details strong {
            color: #212529;
        }

        /* --- Layout --- */
        .exam-layout { display: flex; flex-wrap: wrap; gap: 20px; }
        .question-area { flex: 3; min-width: 300px; }
        .palette-area { flex: 1; min-width: 250px; }

        /* --- Question Palette --- */
        .question-palette {
            position: sticky;
            top: 20px; /* Stick to top */
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        /* --- Timer (Moved) --- */
        .timer-display {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .timer-display .timer-label {
            font-size: 0.9rem;
            color: #6c757d;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .timer-display #timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: #d9534f;
            line-height: 1.2;
        }

        .palette-body { padding: 15px; }
        .palette-header { font-weight: bold; margin-bottom: 15px; }
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
        }
        .q-palette-btn {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px;
            border: 1px solid #ddd; border-radius: 5px; cursor: pointer;
            background-color: #f8f9fa; font-weight: 500;
            transition: all 0.2s ease;
        }
        .q-palette-btn:hover { background-color: #e2e6ea; }
        .q-palette-btn.active {
            background-color: #0d6efd; color: white; border-color: #0d6efd;
            box-shadow: 0 0 5px rgba(13,110,253,0.5); transform: scale(1.05);
        }
        .q-palette-btn.answered {
            background-color: #198754; color: white; border-color: #198754;
        }
        .q-palette-btn.active.answered {
            background-color: #146c43; border-color: #13653f;
        }

        /* --- Question Card & Options --- */
        .question-card {
            display: none;
            margin-bottom: 20px;
            background-color: #fff;
            border: 0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .question-card.active { display: block; }
        .question-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .question-card .card-body { padding: 1.5rem; }
        .question-card .card-text {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        /* New Option Styling */
        .option-container {
            display: block;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .option-container:hover {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }
        .option-container input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .option-container label {
            cursor: pointer;
            width: 100%;
            margin-bottom: 0;
        }

        .pagination-controls {
            display: flex; justify-content: space-between;
            align-items: center; margin-top: 20px;
        }

    </style>
</head>
<body>

<div class="container my-4">

    <!-- --- NEW STUDENT/EXAM HEADER --- -->
    <div class="student-header">
        <div class="d-flex align-items-center">
            <!-- Student Profile Pic -->
            <div class="flex-shrink-0 me-3">
                <img th:if="${student.profilePicUrl != null}"
                     th:src="@{${student.profilePicUrl}}"
                     alt="Profile"
                     class="student-pic">
                <!-- Default Pic SVG -->
                <svg th:if="${student.profilePicUrl == null}"
                     xmlns="http://www.w3.org/2000/svg" width="70" height="70" fill="currentColor"
                     class="bi bi-person-circle student-pic" viewBox="0 0 16 16"
                     style="background-color: #fff;">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    <path fill-rule="evenodd"
                          d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
            </div>
            <!-- Student Details -->
            <div class="flex-grow-1">
                <h5 class="mb-0" th:text="${student.fullName}">Student Name</h5>
                <p>
                    Email: <small class="text-muted" th:text="${student.username}">student@example.com</small><br>
                    Mobile: <small class="text-muted" th:text="${student.mobileNumber}">9572181024</small>
                </p>

            </div>

        </div>
        <hr>
        <!-- Exam Details -->
        <div class="row exam-details">
            <div class="col-md-4">
                <strong>EXAM:</strong>
                <span th:text="${exam.title}">Exam Title</span>
            </div>
            <div class="col-md-4">
                <strong>TOTAL TIME:</strong>
                <span th:text="${exam.durationInMinutes} + ' minutes'">60 minutes</span>
            </div>
            <div class="col-md-4">
                <strong>TOTAL QUESTIONS:</strong>
                <span th:text="${#lists.size(questions)}">20</span>
            </div>
        </div>
    </div>
    <!-- --- END OF NEW HEADER --- -->

    <form id="exam-form" th:action="@{/exam/submit}" method="post">
        <input type="hidden" name="examId" th:value="${exam.id}" />

        <div class="exam-layout">

            <!-- --- Left Side: Questions --- -->
            <div class="question-area">
                <div th:each="question, iter : ${questions}"
                     class="card question-card"
                     th:id="|q-card-${iter.index}|"
                     th:data-question-index="${iter.index}">

                    <div class="card-header" th:text="|Question ${iter.count} (Marks: ${question.marks})|">
                        Question
                    </div>
                    <div class="card-body">
                        <p class="card-text" th:text="${question.text}">Question text...</p>

                        <!-- --- NEW CLICKABLE OPTIONS --- -->
                        <div class="option-container">
                            <label th:for="|q${question.id}_opt1|">
                                <input class="form-check-input" type="radio" th:name="|q_${question.id}|" th:id="|q${question.id}_opt1|" value="1" required>
                                <span th:text="${question.option1}">Option 1</span>
                            </label>
                        </div>
                        <div class="option-container">
                            <label th:for="|q${question.id}_opt2|">
                                <input class="form-check-input" type="radio" th:name="|q_${question.id}|" th:id="|q${question.id}_opt2|" value="2">
                                <span th:text="${question.option2}">Option 2</span>
                            </label>
                        </div>
                        <div class="option-container">
                            <label th:for="|q${question.id}_opt3|">
                                <input class="form-check-input" type="radio" th:name="|q_${question.id}|" th:id="|q${question.id}_opt3|" value="3">
                                <span th:text="${question.option3}">Option 3</span>
                            </label>
                        </div>
                        <div class="option-container">
                            <label th:for="|q${question.id}_opt4|">
                                <input class="form-check-input" type="radio" th:name="|q_${question.id}|" th:id="|q${question.id}_opt4|" value="4">
                                <span th:text="${question.option4}">Option 4</span>
                            </label>
                        </div>

                    </div>
                </div>

                <!-- Pagination Buttons -->
                <div class="pagination-controls">
                    <button type="button" id="prev-btn" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                    <button type="button" id="next-btn" class="btn btn-primary btn-lg">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- --- Right Side: Question Palette --- -->
            <div class="palette-area">
                <div class="question-palette">
                    <!-- Timer (Moved Here) -->
                    <div class="timer-display">
                        <div class="timer-label">Time Left</div>
                        <div id="timer">--:--</div>
                    </div>
                    <!-- Palette Body -->
                    <div class="palette-body">
                        <div class="palette-header">Question Palette</div>
                        <div class="palette-grid">
                            <button type="button"
                                    th:each="q, iter : ${questions}"
                                    class="q-palette-btn"
                                    th:text="${iter.count}"
                                    th:data-question-index="${iter.index}">
                            </button>
                        </div>
                    </div>
                    <!-- Final Submit Button -->
                    <button type="submit" id="submit-btn" class="btn btn-success btn-lg w-100 m-3" style="width: calc(100% - 2*1rem) !important;">
                        <i class="bi bi-check-circle-fill me-2"></i>Submit Exam
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- JS Imports -->
<script th:src="@{/js/exam-timer.js}"></script>

<!-- Timer & Pagination Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- TIMER SETUP ---
        var durationInMinutes = [[${exam.durationInMinutes}]];
        var timerDisplay = document.getElementById('timer');
        var examForm = document.getElementById('exam-form');
        startTimer(durationInMinutes, timerDisplay, examForm);

        // --- PAGINATION SETUP ---
        const questions = document.querySelectorAll('.question-card');
        const paletteBtns = document.querySelectorAll('.q-palette-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        let currentQuestionIndex = 0;
        const totalQuestions = questions.length;

        function showQuestion(index) {
            if (index < 0 || index >= totalQuestions) return;
            questions.forEach(q => q.classList.remove('active'));
            const newQuestion = document.getElementById('q-card-' + index);
            if (newQuestion) newQuestion.classList.add('active');
            paletteBtns.forEach(btn => btn.classList.remove('active'));
            const newPaletteBtn = document.querySelector(`.q-palette-btn[data-question-index="${index}"]`);
            if (newPaletteBtn) newPaletteBtn.classList.add('active');
            currentQuestionIndex = index;
            prevBtn.disabled = (currentQuestionIndex === 0);
            nextBtn.disabled = (currentQuestionIndex === totalQuestions - 1);
        }

        nextBtn.addEventListener('click', () => showQuestion(currentQuestionIndex + 1));
        prevBtn.addEventListener('click', () => showQuestion(currentQuestionIndex - 1));

        paletteBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const index = parseInt(btn.getAttribute('data-question-index'));
                showQuestion(index);
            });
        });

        // Mark question as 'answered' in the palette
        const allRadioButtons = document.querySelectorAll('input[type="radio"]');
        allRadioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                const questionCard = this.closest('.question-card');
                const index = questionCard.getAttribute('data-question-index');
                const paletteBtn = document.querySelector(`.q-palette-btn[data-question-index="${index}"]`);
                if (paletteBtn) {
                    paletteBtn.classList.add('answered');
                }
            });
        });

        // Initial State
        showQuestion(0);
    });
</script>

</body>
</html>