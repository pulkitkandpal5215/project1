<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Manage Students</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
        body {
            background-color: #f8f9fa; /* Light gray background */
        }
    </style>
</head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<div class="container mt-5">

  <!-- Alert Messages -->
  <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Error:</strong> <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- --- NEW: DECORATED HEADER --- -->
  <div class="pb-3 mb-4 border-bottom d-flex align-items-center">
    <i class="bi bi-people-fill me-3" style="font-size: 2.5rem; color: #0d6efd;"></i>
    <div>
      <h2 class="mb-0">Manage Student Accounts</h2>
      <p class="text-muted mb-0">Reset passwords and manage all registered students.</p>
    </div>
  </div>

  <!-- --- NEW: STYLED CARD WRAPPER --- -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th scope="col">Student</th>
            <th scope="col">Email (Username)</th>
            <th scope="col">Mobile Number</th>
            <th scope="col">Actions</th>
          </tr>
          </thead>
          <tbody>

          <!-- Empty State Message -->
          <tr th:if="${#lists.isEmpty(students)}">
            <td colspan="4" class="text-center text-muted p-4">
              <i class="bi bi-person-x" style="font-size: 2rem;"></i>
              <p class="mb-0 mt-2">No student accounts have been created yet.</p>
            </td>
          </tr>

          <!-- Student Row Loop -->
          <tr th:each="student : ${students}">

            <!-- Student Name & Pic -->
            <td>
              <div class="d-flex align-items-center">
                <img th:if="${student.profilePicUrl != null}"
                     th:src="@{${student.profilePicUrl}}"
                     alt="Profile"
                     class="navbar-profile-pic" style="width: 40px; height: 40px;">
                <svg th:if="${student.profilePicUrl == null}"
                     xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
                     class="bi bi-person-circle navbar-profile-pic" viewBox="0 0 16 16">
                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                  <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
                <span class="ms-2 fw-bold" th:text="${student.fullName}">Sumit Kumar</span>
              </div>
            </td>

            <!-- Email -->
            <td th:text="${student.username}">student@example.com</td>

            <!-- Mobile -->
            <td th:text="${student.mobileNumber}">+123456789</td>

            <!-- Actions -->
            <td>
              <!-- Reset Password Button: Triggers the modal -->
              <button type="button" class="btn btn-sm btn-warning me-1"
                      title="Reset Password" data-bs-toggle="modal"
                      data-bs-target="#resetPasswordModal"
                      th:attr="data-student-id=${student.id}, data-student-name=${student.username}">
                <i class="bi bi-key-fill"></i> Reset Password
              </button>

              <!-- Delete Student Button -->
              <a th:href="@{/admin/student/delete/{id}(id=${student.id})}"
                 class="btn btn-sm btn-danger" title="Delete Student"
                 onclick="return confirm('Are you sure you want to delete this student? This will also delete ALL of their exam results and answers. This action cannot be undone.');">
                <i class="bi bi-trash-fill"></i> Delete
              </a>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resetPasswordModalLabel">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <!-- Form to reset the password -->
      <form th:action="@{/admin/student/reset-password}" method="post">
        <div class="modal-body">
          <p>You are resetting the password for: <strong id="studentNameLabel"></strong></p>

          <input type="hidden" id="modalStudentId" name="userId" value="">

          <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-warning">Reset Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // This JavaScript is still correct
    var resetPasswordModal = document.getElementById('resetPasswordModal');
    resetPasswordModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var studentId = button.getAttribute('data-student-id');
        var studentName = button.getAttribute('data-student-name');
        var modalStudentIdInput = resetPasswordModal.querySelector('#modalStudentId');
        var modalStudentNameLabel = resetPasswordModal.querySelector('#studentNameLabel');
        modalStudentIdInput.value = studentId;
        modalStudentNameLabel.textContent = studentName;
    });
</script>
</body>
</html>